<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Trophy Tracker</title>
<style>
body{margin:0;font-family:system-ui;background:#0b1020;color:#e8ecff}
header{background:#111a33;padding:12px;position:sticky;top:0}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;padding:12px}
.card{background:#151f40;border:1px solid #2a3470;border-radius:14px;padding:12px;cursor:pointer}
.progress{height:8px;background:#222;border-radius:999px;overflow:hidden;margin-top:8px}
.progress div{height:100%;background:#7aa2ff}
.panel{background:#151f40;border:1px solid #2a3470;border-radius:14px;padding:12px;margin:12px}
button{background:#222;color:white;border:1px solid #444;padding:6px 10px;border-radius:10px;cursor:pointer}
.trophy{border-top:1px solid #333;padding:8px 0}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center}
.modal.open{display:flex}
.modal-box{background:#151f40;border-radius:14px;padding:14px;max-width:900px;width:100%;max-height:85vh;overflow:auto}
.tag{border:1px solid #555;padding:3px 8px;border-radius:999px;font-size:12px;margin-right:6px}
</style>
</head>
<body>
<header><h2>Trophy Tracker</h2></header>
<div id="app"></div>

<div id="guideModal" class="modal">
<div class="modal-box">
<button onclick="closeGuide()">Close</button>
<div id="guideContent"></div>
</div>
</div>

<script>
let GAME_DATA = {};
let TROPHY_GUIDES = {};
let CHECKED = JSON.parse(localStorage.getItem("checkedTrophies")||"{}");
let currentGame = null;

async function loadData(){
  const p = await fetch("./data/progress.json");
  GAME_DATA = await p.json();
  const g = await fetch("./data/guides.json");
  TROPHY_GUIDES = await g.json();
}

function saveChecked(){
  localStorage.setItem("checkedTrophies",JSON.stringify(CHECKED));
}

function renderHome(){
  const app = document.getElementById("app");
  app.innerHTML = `<div class="grid">${
    Object.entries(GAME_DATA).map(([name,game])=>{
      const earned = Array.isArray(game.earned) ? game.earned.length : 0;
      const unearned = Array.isArray(game.unearned) ? game.unearned.length : 0;
      const total = earned + unearned;
      const pct = total ? Math.round(earned/total*100) : 0;
      return `<div class="card" onclick="openGame('${name}')">
        <h3>${name}</h3>
        <div>${earned}/${total} trophies</div>
        <div class="progress"><div style="width:${pct}%"></div></div>
      </div>`;
    }).join("")
  }</div>`;
}

function openGame(name){
  currentGame = name;
  const game = GAME_DATA[name];
  const unearned = Array.isArray(game.unearned) ? game.unearned : [];
  const app = document.getElementById("app");

  app.innerHTML = `
  <button onclick="renderHome()">‚Üê Back</button>
  <div class="panel">
  <h3>${name}</h3>
  ${unearned.map(t=>{
    const key = name+"|"+t.name;
    const checked = CHECKED[key];
    return `<div class="trophy">
      <label>
      <input type="checkbox" ${checked?"checked":""} onchange="toggle('${key}')">
      <strong>${t.name}</strong><br>${t.desc}
      </label>
      <button onclick="openGuide('${name}','${t.name}')">Guide</button>
    </div>`;
  }).join("")}
  </div>`;
}

function toggle(key){
  CHECKED[key]=!CHECKED[key];
  saveChecked();
}

function openGuide(game,trophy){
  const guide = TROPHY_GUIDES[game]?.[trophy];
  if(!guide){ alert("No guide added yet"); return; }

  let html = `<h3>${trophy}</h3>`;
  if(guide.tags){
    html+=guide.tags.map(t=>`<span class="tag">${t.label}</span>`).join("");
  }
  guide.sections.forEach(sec=>{
    html+=`<h4>${sec.title}</h4><ol>${sec.steps.map(s=>`<li>${s}</li>`).join("")}</ol>`;
  });
  guide.tips?.forEach(t=>{ html+=`<div class="tag">${t.text}</div>`; });
  if(guide.source){ html+=`<p><a href="${guide.source.url}" target="_blank">${guide.source.label}</a></p>`; }

  document.getElementById("guideContent").innerHTML = html;
  document.getElementById("guideModal").classList.add("open");
}

function closeGuide(){
  document.getElementById("guideModal").classList.remove("open");
}

async function init(){
  await loadData();
  renderHome();
}

init();
</script>
</body>
</html>
